# NIPT最佳时点选择分析 - 问题3多因素分析

**生成时间**: 2025年1月

## 📋 项目概述

本项目基于数学建模竞赛问题3，采用多因素综合分析模型，综合考虑身高、体重、年龄、BMI等多种因素对男胎孕妇进行分组，并为每组确定最佳NIPT（无创产前检测）时点，以最小化孕妇的潜在风险。

### 核心目标
- 综合考虑多种因素进行科学分组
- 为每个多因素组确定最优NIPT检测时点
- 最小化检测失败风险和延误诊断风险
- 满足95%成功概率约束条件
- 分析检测误差对结果的影响

## 🔬 技术架构

### 1. 时间预测模型 (`time_prediction_problem3.py`)
- **基础**: 基于第一问增强混合效应模型
- **考虑因素**: BMI、年龄、身高、体重、X染色体浓度、检测质量等
- **核心功能**:
  - 多因素Y染色体浓度预测
  - 达标时间求解
  - 成功概率计算
  - 多因素综合评分

### 2. 多因素分组模块 (`multifactor_grouping.py`)
- **算法**: K-means聚类 + 层次聚类
- **特征工程**: 20+个多因素特征
- **分组策略**: 基于多因素综合评分
- **约束验证**: BMI分段约束、样本分布平衡

### 3. 风险模型 (`risk_model_problem3.py`)
- **风险类型**: 延误诊断风险 + 检测失败风险
- **多因素修正**: 考虑多因素评分对风险的影响
- **约束检查**: 三大约束条件验证
- **敏感性分析**: 检测误差影响评估

### 4. 主分析流程 (`main_problem3.py`)
- **完整流程**: 8步分析流程
- **数据集成**: 整合所有模块
- **结果生成**: 临床建议和约束验证
- **结果保存**: 结构化数据输出

### 5. 可视化模块 (`visualization_problem3.py`)
- **多因素分析图**: 达标时间与各因素关系
- **分组结果图**: 分组统计和分布
- **相关性热力图**: 特征间相关性分析
- **敏感性分析图**: 误差影响分析
- **综合仪表板**: 整体分析结果展示

## 📊 多因素特征体系

### 基础特征
- **BMI**: 身体质量指数
- **年龄**: 孕妇年龄
- **身高**: 孕妇身高
- **体重**: 孕妇体重

### 交互特征
- **BMI²**: BMI平方项
- **BMI×年龄**: BMI与年龄交互
- **身高体重比**: 身高体重比值
- **BMI×身高**: BMI与身高交互
- **BMI×体重**: BMI与体重交互
- **年龄×身高**: 年龄与身高交互
- **年龄×体重**: 年龄与体重交互

### 检测质量特征
- **X染色体浓度**: X染色体浓度水平
- **Y染色体Z值**: Y染色体标准化Z值
- **X染色体Z值**: X染色体标准化Z值
- **18号染色体Z值**: 18号染色体标准化Z值
- **检测抽血次数**: 抽血检测次数

### 复合特征
- **多因素综合评分**: 加权综合评分
- **风险敏感指数**: 单位时间风险
- **多因素×风险交互**: 多因素与风险交互项

## 🎯 分析流程

### Step 1: 数据加载与预处理
- 加载男胎检测数据
- 数据清洗和特征工程
- 添加缺失的检测质量指标

### Step 2: 多因素达标时间预测
- 基于第一问增强模型预测达标时间
- 计算95%概率约束时间
- 生成多因素综合评分

### Step 3: 多因素分组优化
- 准备20+个多因素特征
- 使用聚类算法进行分组
- 优化分组数量和样本分布

### Step 4: 多因素组检测时间优化
- 为每个组优化检测时间
- 计算最小期望风险
- 验证组内稳妥达标约束

### Step 5: 多因素敏感性分析
- 分析检测误差对各组的影响
- 评估风险变化范围
- 生成敏感性报告

### Step 6: 生成最终多因素建议
- 验证三大约束条件
- 生成临床建议
- 输出分组规则

### Step 7: 创建可视化图表
- 多因素关系分析图
- 分组结果展示图
- 敏感性分析图
- 综合仪表板

### Step 8: 保存分析结果
- 保存数据文件
- 保存模型参数
- 生成分析报告

## 📈 预期结果

### 分组结果
- **分组数量**: 3-5个多因素组
- **分组依据**: 多因素综合评分
- **样本分布**: 相对均衡的样本分布

### 检测时点
- **时间范围**: 10-25周
- **个体化**: 基于多因素特征
- **风险最小化**: 最小期望风险

### 约束验证
- **BMI分段约束**: 相邻且不交的BMI区间
- **检测时窗约束**: 在10-25周范围内
- **组内稳妥达标约束**: 95%成功概率要求

## 🔧 使用方法

### 基本使用
```python
from main_problem3 import Problem3CompleteAnalysis

# 创建分析器
analyzer = Problem3CompleteAnalysis("数据文件路径")

# 运行完整分析
results = analyzer.run_complete_multifactor_analysis()
```

### 单独使用模块
```python
from time_prediction_problem3 import TimePredictionModelProblem3
from multifactor_grouping import MultifactorGrouping
from risk_model_problem3 import RiskModelProblem3

# 初始化模块
time_predictor = TimePredictionModelProblem3()
grouping = MultifactorGrouping()
risk_model = RiskModelProblem3()
```

## 📁 输出文件结构

```
problem3_results/
├── data/
│   ├── 多因素预测达标时间.csv
│   ├── 多因素特征数据.csv
│   ├── 多因素分组规则.csv
│   └── 多因素最终临床建议.csv
├── figures/
│   ├── 多因素达标时间分析.png
│   ├── 多因素分组结果.png
│   ├── 多因素相关性热力图.png
│   ├── 多因素敏感性分析.png
│   └── 多因素综合分析仪表板.png
├── models/
│   ├── 时间预测模型参数.json
│   ├── 风险模型参数.json
│   └── 聚类模型参数.json
└── reports/
    └── 问题3多因素分析报告.md
```

## 🎯 创新点

### 1. 多因素综合评估
- 不仅考虑BMI，还综合考虑年龄、身高、体重等因素
- 引入检测质量指标（X染色体浓度、Z值等）
- 建立多因素综合评分体系

### 2. 增强的时间预测模型
- 基于第一问最新的增强混合效应模型
- 考虑更多变量和交互项
- 提高预测精度和可靠性

### 3. 智能分组算法
- 结合K-means和层次聚类
- 基于多因素特征进行分组
- 自动优化分组数量和分布

### 4. 多因素风险模型
- 考虑多因素对风险的影响
- 建立多因素修正机制
- 提供更准确的风险评估

### 5. 全面的约束验证
- 验证BMI分段约束
- 验证检测时窗约束
- 验证组内稳妥达标约束

## 📊 技术指标

### 模型性能
- **预测精度**: 基于第一问增强模型
- **分组质量**: 轮廓系数 + Calinski-Harabasz指数
- **约束满足**: 三大约束条件验证

### 计算效率
- **特征维度**: 20+个多因素特征
- **分组数量**: 3-5个组
- **样本规模**: 支持200+个样本

### 可解释性
- **特征重要性**: 多因素权重分析
- **分组规则**: 清晰的分组边界
- **临床建议**: 实用的临床指导

## 🔍 注意事项

1. **数据质量**: 确保输入数据包含所有必要的多因素特征
2. **参数调优**: 可根据实际数据调整分组数量和样本分布
3. **约束验证**: 定期检查三大约束条件的满足情况
4. **模型更新**: 根据新的数据定期更新模型参数

## 📞 技术支持

如有问题或建议，请参考：
- 代码注释和文档字符串
- 各模块的测试用例
- 分析报告和结果解释

---

**版本**: 1.0  
**最后更新**: 2025年1月  
**兼容性**: Python 3.7+