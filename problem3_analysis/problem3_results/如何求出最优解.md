
## 问题3中最佳时点求解的数学建模方法

### 1. 优化问题的数学表述

**目标函数**：
```
min R_total(t) = R_delay(t) + R_detection(t)
```

**约束条件**：
```
10 ≤ t ≤ 25 (周)
P_success(t) ≥ 0.95
```

### 2. 风险函数的构建

#### 2.1 总风险函数
```python
def calculate_multifactor_total_risk(self, gestational_days, bmi, age, height, weight, time_predictor):
    # 计算多因素评分
    multifactor_score = time_predictor.calculate_multifactor_score(bmi, age, height, weight)
    
    # 预测成功概率
    success_probability = time_predictor.predict_达标概率(gestational_days, bmi, age, height, weight)
    
    # 计算延误风险
    delay_risk = self.calculate_multifactor_delay_risk(gestational_days, multifactor_score)
    
    # 计算检测失败风险
    detection_failure_risk = self.calculate_multifactor_detection_failure_risk(success_probability, multifactor_score)
    
    # 总风险
    total_risk = delay_risk + detection_failure_risk
    
    return total_risk
```

#### 2.2 延误风险函数（分段函数）
```python
def calculate_multifactor_delay_risk(self, gestational_days, multifactor_score):
    weeks = gestational_days / 7
    
    # 基础延误风险（分段线性函数）
    if weeks <= 12:
        base_risk = 0.1 + 0.02 * weeks
    elif weeks <= 20:
        base_risk = 0.5 + 0.08 * (weeks - 12)
    else:
        base_risk = 2.0 + 0.2 * (weeks - 20)
    
    # 多因素修正
    multifactor_modifier = 1 + (multifactor_score - 0.5) * 1.2
    
    return base_risk * multifactor_modifier
```

**数学表达式**：
```
R_delay(t, S_multifactor) = R_base(t) × (1 + (S_multifactor - 0.5) × 1.2)
```

其中：
```
R_base(t) = {
    0.1 + 0.02t,           if t ≤ 12周
    0.5 + 0.08(t-12),      if 12 < t ≤ 20周
    2.0 + 0.2(t-20),       if t > 20周
}
```

#### 2.3 检测失败风险函数
```python
def calculate_multifactor_detection_failure_risk(self, success_probability, multifactor_score):
    # 基础检测失败风险
    base_risk = (1 - success_probability) * 10.0
    
    # 多因素修正
    multifactor_modifier = 1 + (multifactor_score - 0.5) * 1.5
    
    return base_risk * multifactor_modifier
```

**数学表达式**：
```
R_detection(t, S_multifactor) = (1 - P_success(t)) × 10.0 × (1 + (S_multifactor - 0.5) × 1.5)
```

### 3. 成功概率预测模型

```python
def predict_达标概率(self, gestational_days, bmi, age, height, weight, ...):
    # 预测浓度
    predicted_conc = self.predict_concentration(gestational_days, bmi, age, height, weight, ...)
    
    # 计算总误差方差
    total_variance = measurement_error**2 + individual_effect_std**2
    
    # 计算达标概率
    z_score = (threshold - predicted_conc) / np.sqrt(total_variance)
    success_probability = 1 - norm.cdf(z_score)
    
    return success_probability
```

**数学表达式**：
```
P_success(t) = 1 - Φ((threshold - Y_pred(t)) / σ_total)
```

其中：
- `Y_pred(t)`：基于第一问混合效应模型的浓度预测
- `σ_total`：总误差标准差
- `threshold = 0.04`：达标阈值

### 4. 优化算法实现

#### 4.1 组内风险目标函数
```python
def group_risk_objective(test_time_weeks):
    test_time_days = test_time_weeks * 7
    total_risk = 0
    valid_patients = 0
    
    for _, patient in group_data.iterrows():
        risk_result = self.calculate_multifactor_total_risk(
            test_time_days, patient['BMI'], patient['年龄'], 
            patient['身高'], patient['体重'], time_predictor
        )
        total_risk += risk_result['total_risk']
        valid_patients += 1
    
    return total_risk / valid_patients  # 组内平均风险
```

#### 4.2 有界优化求解
```python
from scipy.optimize import minimize_scalar

result = minimize_scalar(
    group_risk_objective,
    bounds=(min_week, max_week),  # 10-25周
    method='bounded'
)

optimal_time_weeks = result.x
minimal_risk = result.fun
```

### 5. 优化过程的数学原理

#### 5.1 风险函数的性质
1. **延误风险**：随孕周增加而单调递增
2. **检测失败风险**：随成功概率增加而单调递减
3. **总风险**：在某个时点达到最小值

#### 5.2 最优解的存在性
由于：
- 延误风险函数连续且单调递增
- 检测失败风险函数连续且单调递减
- 定义域有界：[10, 25]周

根据极值定理，总风险函数在定义域内必定存在最小值。

#### 5.3 约束处理
```python
# 约束检查
satisfies_constraint = success_probability >= self.target_success_probability
```

如果约束不满足，优化算法会：
1. 增加检测失败风险（惩罚项）
2. 调整优化方向
3. 寻找满足约束的最优解

### 6. 实际运行结果

从运行结果可以看出：
- **所有分组的推荐检测时间都在11.1-11.8周之间**
- **风险水平在0.318-0.349之间**
- **所有分组的成功概率都达到100%**

这表明：
1. **早期检测最优**：在11-12周检测能获得最小风险
2. **风险-收益平衡**：既满足95%成功概率约束，又最小化延误风险
3. **模型稳定性好**：不同分组的结果相对稳定

### 7. 数学建模的创新点

1. **多因素综合**：不仅考虑BMI，还整合年龄、身高、体重等因素
2. **分段风险函数**：根据临床经验设计分段线性风险函数
3. **约束优化**：在满足95%成功概率约束下最小化总风险
4. **组内平均**：考虑组内所有个体的平均风险，而非单个个体

这种方法将复杂的多因素优化问题转化为可求解的约束优化问题，既保证了数学严谨性，又具有临床实用性。